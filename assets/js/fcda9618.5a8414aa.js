"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4749],{51850:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>u,frontMatter:()=>d,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"TOC/computer/kernel/ldd/ch03","title":"\u7b2c\u4e09\u7ae0 \u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f[^1]","description":"\u4ee3\u7801\u4f4d\u7f6e\uff1aldd3/scull at main \xb7 Zefrain/ldd3 (github.com)","source":"@site/docs/TOC/computer/kernel/ldd/ch03.md","sourceDirName":"TOC/computer/kernel/ldd","slug":"/TOC/computer/kernel/ldd/ch03","permalink":"/docs/TOC/computer/kernel/ldd/ch03","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u7b2c\u4e8c\u7ae0 \u6784\u9020\u548c\u8fd0\u884c\u6a21\u5757","permalink":"/docs/TOC/computer/kernel/ldd/ch02"},"next":{"title":"\u7b2c\u56db\u7ae0 \u8c03\u8bd5\u6280\u672f","permalink":"/docs/TOC/computer/kernel/ldd/ch04"}}');var s=i(74848),l=i(28453);const d={},c="\u7b2c\u4e09\u7ae0 \u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f",r={},o=[{value:"scull \u7684\u8bbe\u8ba1",id:"scull-\u7684\u8bbe\u8ba1",level:2},{value:"\u4e3b\u8bbe\u5907\u53f7\u548c\u6b21\u8bbe\u5907\u53f7",id:"\u4e3b\u8bbe\u5907\u53f7\u548c\u6b21\u8bbe\u5907\u53f7",level:2},{value:"\u8bbe\u5907\u7f16\u53f7\u7684\u5185\u90e8\u8868\u8fbe",id:"\u8bbe\u5907\u7f16\u53f7\u7684\u5185\u90e8\u8868\u8fbe",level:2},{value:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u7f16\u53f7",id:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u7f16\u53f7",level:2},{value:"\u4e00\u4e9b\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784",id:"\u4e00\u4e9b\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784",level:2},{value:"\u6587\u4ef6\u64cd\u4f5c<code>&lt;linux/fs.h&gt;</code>",id:"\u6587\u4ef6\u64cd\u4f5clinuxfsh",level:3},{value:"file \u7ed3\u6784 <code>&lt;linux/fs.h&gt;</code>",id:"file-\u7ed3\u6784-linuxfsh",level:3},{value:"inode \u7ed3\u6784 <code>&lt;linux/fs.h&gt;</code>",id:"inode-\u7ed3\u6784-linuxfsh",level:3},{value:"\u5b57\u7b26\u8bbe\u5907\u7684\u6ce8\u518c <code>&lt;linux/cdev.h&gt;</code>",id:"\u5b57\u7b26\u8bbe\u5907\u7684\u6ce8\u518c-linuxcdevh",level:2},{value:"open \u548c release",id:"open-\u548c-release",level:2},{value:"open \u65b9\u6cd5",id:"open-\u65b9\u6cd5",level:3},{value:"release \u65b9\u6cd5",id:"release-\u65b9\u6cd5",level:3},{value:"scull \u7684\u5185\u5b58\u4f7f\u7528",id:"scull-\u7684\u5185\u5b58\u4f7f\u7528",level:2},{value:"read \u548c write \u65b9\u6cd5",id:"read-\u548c-write-\u65b9\u6cd5",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",strong:"strong",sup:"sup",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsxs)(n.h1,{id:"\u7b2c\u4e09\u7ae0-\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f",children:["\u7b2c\u4e09\u7ae0 \u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f",(0,s.jsx)(n.sup,{children:(0,s.jsx)(n.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})})]})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee3\u7801\u4f4d\u7f6e\uff1a",(0,s.jsx)(n.a,{href:"https://github.com/Zefrain/ldd3/tree/main/scull",children:"ldd3/scull at main \xb7 Zefrain/ldd3 (github.com)"})]}),"\n",(0,s.jsx)(n.h2,{id:"scull-\u7684\u8bbe\u8ba1",children:"scull \u7684\u8bbe\u8ba1"}),"\n",(0,s.jsx)(n.p,{children:"\u7f16\u5199\u9a71\u52a8\u7a0b\u5e8f\u7684\u7b2c\u4e00\u6b65\u5c31\u662f\u5b9a\u4e49\u9a71\u52a8\u7a0b\u5e8f\u4e3a\u7528\u6237\u7a0b\u5e8f\u63d0\u4f9b\u7684\u80fd\u529b\uff08\u673a\u5236\uff09\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u4e3b\u8bbe\u5907\u53f7\u548c\u6b21\u8bbe\u5907\u53f7",children:"\u4e3b\u8bbe\u5907\u53f7\u548c\u6b21\u8bbe\u5907\u53f7"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4e3b\u8bbe\u5907\u53f7\u6807\u8bc6\u8bbe\u5907\u5bf9\u5e94\u7684\u9a71\u52a8\u7a0b\u5e8f"}),"\n",(0,s.jsx)(n.li,{children:"\u6b21\u8bbe\u5907\u53f7\u7531\u5185\u6838\u4f7f\u7528\uff0c\u7528\u4e8e\u6b63\u786e\u786e\u5b9a\u8bbe\u5907\u6587\u4ef6\u6240\u6307\u7684\u8bbe\u5907\u3002"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ls -l"}),"\u7b2c 5 \u5217\u4e3a\u4e3b\u8bbe\u5907\u53f7\uff0c\u7b2c6\u5217\u4e3a\u6b21\u8bbe\u5907\u53f7\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u8bbe\u5907\u7f16\u53f7\u7684\u5185\u90e8\u8868\u8fbe",children:"\u8bbe\u5907\u7f16\u53f7\u7684\u5185\u90e8\u8868\u8fbe"}),"\n",(0,s.jsx)(n.p,{children:"dev_t\u662f\u4e00\u4e2a32\u4f4d\u6574\u578b\uff0c\u5176\u4e2d12\u4f4d\u8868\u793a\u4e3b\u8bbe\u5907\u53f7\uff0c\u5176\u4f5920\u4f4d\u8868\u793a\u6b21\u8bbe\u5907\u53f7\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"typedef u_long dev_t;\n\n#define MINORBITS\t20\n#define MINORMASK\t((1U << MINORBITS) - 1)\n\n#define MAJOR(dev)\t((unsigned int) ((dev) >> MINORBITS))\n#define MINOR(dev)\t((unsigned int) ((dev) & MINORMASK))\n#define MKDEV(ma,mi)\t(((ma) << MINORBITS) | (mi)) \n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u7f16\u53f7",children:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u7f16\u53f7"}),"\n",(0,s.jsxs)(n.p,{children:["\u5934\u6587\u4ef6\u5728",(0,s.jsx)(n.code,{children:"<linux/fs.h>"}),"\uff0c\u5b9e\u73b0\u5728",(0,s.jsx)(n.code,{children:"fs/char_dev.c"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"int register_chrdev_region(dev_t from, unsigned count, const char *name);\nvoid unregister_chrdev_region(dev_t from, unsigned count);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4e00\u4e9b\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784",children:"\u4e00\u4e9b\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784"}),"\n",(0,s.jsxs)(n.h3,{id:"\u6587\u4ef6\u64cd\u4f5clinuxfsh",children:["\u6587\u4ef6\u64cd\u4f5c",(0,s.jsx)(n.code,{children:"<linux/fs.h>"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"struct file_operations {\n\tstruct module *owner; /* THIS_MODULE defined in <linux/module.h> */\n\tloff_t (*llseek) (struct file *, loff_t, int);\n\tssize_t (*read) (struct file *, char __user *, size_t, loff_t *);\n\tssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);\n\tssize_t (*aio_read) (struct kiocb *, const struct iovec *, unsigned long, loff_t);\n\tssize_t (*aio_write) (struct kiocb *, const struct iovec *, unsigned long, loff_t);\n\tint (*readdir) (struct file *, void *, filldir_t);\n\tunsigned int (*poll) (struct file *, struct poll_table_struct *);\n\tint (*ioctl) (struct inode *, struct file *, unsigned int, unsigned long);\n\tlong (*unlocked_ioctl) (struct file *, unsigned int, unsigned long);\n\tlong (*compat_ioctl) (struct file *, unsigned int, unsigned long);\n\tint (*mmap) (struct file *, struct vm_area_struct *);\n\tint (*open) (struct inode *, struct file *);\n\tint (*flush) (struct file *, fl_owner_t id);\n\tint (*release) (struct inode *, struct file *);\n\tint (*fsync) (struct file *, struct dentry *, int datasync);\n\tint (*aio_fsync) (struct kiocb *, int datasync);\n\tint (*fasync) (int, struct file *, int);\n\tint (*lock) (struct file *, int, struct file_lock *);\n\tssize_t (*sendpage) (struct file *, struct page *, int, size_t, loff_t *, int);\n\tunsigned long (*get_unmapped_area)(struct file *, unsigned long, unsigned long, unsigned long, unsigned long);\n\tint (*check_flags)(int);\n\tint (*flock) (struct file *, int, struct file_lock *);\n\tssize_t (*splice_write)(struct pipe_inode_info *, struct file *, loff_t *, size_t, unsigned int);\n\tssize_t (*splice_read)(struct file *, loff_t *, struct pipe_inode_info *, size_t, unsigned int);\n\tint (*setlease)(struct file *, long, struct file_lock **);\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u6807\u8bb0\u5316\u7684\u521d\u59cb\u5316\u65b9\u6cd5\u5141\u8bb8 \u5bf9\u7ed3\u6784\u6210\u5458\u8fdb\u884c\u91cd\u65b0\u6392\u5217\u3002\u5728\u67d0\u4e9b\u573a\u5408\u4e0b\uff0c\u5c06\u9891\u7e41\u88ab\u8bbf\u95ee\u7684\u6210\u5458\u653e\u5728\u76f8\u540c\u7684\u786c\u4ef6\u7f13\u5b58\u884c\u4e0a\uff0c\u5c06\u5927\u5927\u63d0\u9ad8\u6027\u80fd\u3002"})}),"\n",(0,s.jsxs)(n.h3,{id:"file-\u7ed3\u6784-linuxfsh",children:["file \u7ed3\u6784 ",(0,s.jsx)(n.code,{children:"<linux/fs.h>"})]}),"\n",(0,s.jsx)(n.p,{children:"\u6700\u91cd\u8981\u7684\u6210\u5458\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"fmode_t                       f_mode;       // \u6587\u4ef6\u6a21\u5f0f\nloff_t                        f_pos;        // \u5f53\u524d\u7684\u8bfb/\u5199\u4f4d\u7f6e\nunsigned int                  f_flags;      // \u6587\u4ef6\u6807\u5fd7\uff0c\u5982 R_RDONLY, O_NONBLOCK, O_SYNC\nconst struct file_operations *f_op;         // \u6587\u4ef6\u64cd\u4f5c\u7ed3\u6784\u4f53\u6307\u9488\nvoid                         *private_data; // \u9a71\u52a8 \u7a0b\u5e8f\u53ef\u4ee5\u7528\u8fd9\u4e2a\u5b57\u6bb5\u6307\u5411\u5df2\u5206\u914d\u7684\u6570\u636e\uff0c\u4f46\u5fc5\u987b\u5728\u5185\u6838\u9500\u6bc1file\u7ed3\u6784\u524d\u91ca\u653e\nstruct dentry                *f_dentry;     // \u6587\u4ef6cfyi\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"inode-\u7ed3\u6784-linuxfsh",children:["inode \u7ed3\u6784 ",(0,s.jsx)(n.code,{children:"<linux/fs.h>"})]}),"\n",(0,s.jsx)(n.p,{children:"\u6709\u7528\u7684\u5b57\u6bb5\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"dev_t        i_rdev;            // \u5305\u542b\u4e86\u771f\u6b63\u7684\u8bbe\u5907\u7f16\u53f7\nstruct cdev *i_cdev;            // \u5305\u542b\u4e86\u6307\u5411struct cdev \u7ed3\u6784\u7684\u6307\u9488\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"\u5b57\u7b26\u8bbe\u5907\u7684\u6ce8\u518c-linuxcdevh",children:["\u5b57\u7b26\u8bbe\u5907\u7684\u6ce8\u518c ",(0,s.jsx)(n.code,{children:"<linux/cdev.h>"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"cdev_init"}),"\u7528\u6765\u521d\u59cb\u5316\u5df2\u5206\u914d\u7684\u7ed3\u6784"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"/**\n * cdev_init() - initialize a cdev structure\n * @cdev: the structure to initialize\n * @fops: the file_operations for this device\n *\n * Initializes @cdev, remembering @fops, making it ready to add to the\n * system with cdev_add().\n */\n\nvoid cdev_init(struct cdev *cdev, struct file_operations *fops);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"cdev_add"}),"\u7528\u6765\u544a\u77e5\u5185\u6838"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"/**\n * cdev_add() - add a char device to the system\n * @p: the cdev structure for the device\n * @dev: the first device number for which this device is responsible\n * @count: the number of consecutive minor numbers corresponding to this\n *         device\n *\n * cdev_add() adds the device represented by @p to the system, making it\n * live immediately.  A negative error code is returned on failure.\n */\nint cdev_add(struct cdev *dev, dev_t num, unsigned int count);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"open-\u548c-release",children:"open \u548c release"}),"\n",(0,s.jsx)(n.h3,{id:"open-\u65b9\u6cd5",children:"open \u65b9\u6cd5"}),"\n",(0,s.jsx)(n.p,{children:"_open_\u5e94\u5b8c\u6210\u7684\u5de5\u4f5c\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u68c0\u67e5\u8bbe\u5907\u7279\u5b9a\u7684\u9519\u8bef\uff08\u5982\u8bbe\u5907\u672a\u5c31\u7eea\u6216\u7c7b\u4f3c\u7684\u786c\u4ef6\u95ee\u9898\uff09"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679c\u8bbe\u5907\u9996\u6b21\u6253\u5f00\uff0c\u5219\u5bf9\u5176\u521d\u59cb\u5316"}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u6709\u5fc5\u8981\uff0c\u66f4\u65b0  ",(0,s.jsx)(n.code,{children:"f_op"}),"\u6307\u9488"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5206\u914d\u5e76\u586b\u5199\u7f6e\u4e8e ",(0,s.jsx)(n.code,{children:"filp->private_data"}),"\u91cc\u7684\u6570\u636e\u7ed3\u6784"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"release-\u65b9\u6cd5",children:"release \u65b9\u6cd5"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u91ca\u653e _open_\u65b9\u6cd5\u4e3a ",(0,s.jsx)(n.code,{children:"filp->private_data"})," \u5206\u914d\u7684\u6570\u636e"]}),"\n",(0,s.jsx)(n.li,{children:"\u5728\u6700\u540e\u4e00\u6b21\u5173\u95ed\u64cd\u4f5c\u65f6\u5173\u95ed\u8bbe\u5907"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"scull-\u7684\u5185\u5b58\u4f7f\u7528",children:"scull \u7684\u5185\u5b58\u4f7f\u7528"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image-20230209222229801",src:i(61210).A+"",width:"1348",height:"712"})}),"\n",(0,s.jsx)(n.h2,{id:"read-\u548c-write-\u65b9\u6cd5",children:"read \u548c write \u65b9\u6cd5"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5728\u5185\u6838\u6a21\u5f0f\u4e2d\u8fd0\u884c\u65f6\uff0c\u7528\u6237\u7a7a\u95f4\u7684\u6307\u9488\u53ef\u80fd\u662f\u65e0\u6548\u7684\u3002"}),"\n",(0,s.jsx)(n.li,{children:"\u5373\u4f7f\u8be5\u6307\u9488\u5728\u5185\u6838\u7a7a\u95f4\u4e2d\u4ee3\u8868\u76f8\u540c\u7684\u4e1c\u897f\uff0c\u4f46\u7528\u6237\u7a7a\u95f4\u7684\u5185\u5b58\u662f\u5206\u9875\u7684\uff0c\u800c\u5728\u7cfb\u7edf\u8c03\u7528\u88ab\u8c03\u7528\u65f6\uff0c\u6d89\u53ca\u5230\u7684\u5185\u5b58\u53ef\u80fd\u6839\u672c\u5c31\u4e0d\u5728RAM\u4e2d\u3002"}),"\n",(0,s.jsx)(n.li,{children:"\u6307\u9488\u53ef\u80fd\u7531\u7528\u6237\u7a0b\u5e8f\u63d0\u4f9b\uff0c\u76f2\u76ee\u5f15\u7528\u7528\u6237\u63d0\u4f9b\u7684\u7684\u6307\u9488\u5c06\u5bfc\u81f4\u7cfb\u7edf\u6253\u5f00\u540e\u95e8\uff0c\u4ece\u800c\u5141\u8bb8\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u968f\u610f\u8bbf\u95ee\u6216\u8986\u76d6\u7cfb\u7edf\u4e2d\u7684\u5185\u5b58\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image-20230209230646993",src:i(34208).A+"",width:"1273",height:"797"})}),"\n","\n",(0,s.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,s.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{id:"user-content-fn-1",children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/Zefrain/ldd3/tree/main/scull",children:"ldd3/scull at main \xb7 Zefrain/ldd3 (github.com)"})," ",(0,s.jsx)(n.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},61210:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/image-20230209222229801-39ae4fa2162f5674bc8e5f5e9bb1b23f.png"},34208:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/image-20230209230646993-03b729110323db618cd1019d1b49dfd7.png"},28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>c});var t=i(96540);const s={},l=t.createContext(s);function d(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);